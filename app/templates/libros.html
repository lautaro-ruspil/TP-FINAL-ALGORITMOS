{% extends "base.html" %}
<!-- Esta plantilla hereda la estructura base del archivo base.html -->

{% block title %}Gestión de Libros{% endblock %}
<!-- Define el título que aparecerá en la pestaña del navegador -->

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/libros.css') }}">
<!-- Carga una hoja de estilo específica para esta vista -->
{% endblock %}

{% block content %}
<!-- Inicio del bloque principal de contenido que se incrusta en base.html -->

<h2>Gestión de Libros</h2>
<!-- Título principal de la página -->

<!-- Formulario de búsqueda y filtrado -->
<form id="filtrado" class="filtrado" method="get" action="{{ url_for('libros') }}">
    <!-- Campo para seleccionar por qué atributo filtrar -->
    <label>
        Filtrar por
        <select name="campo" id="caracteristica">
            <!-- Las opciones conservan el valor seleccionado usando condicionales de Jinja -->
            <option value="titulo" {% if campo == 'titulo' %}selected{% endif %}>Título</option>
            <option value="autor" {% if campo == 'autor' %}selected{% endif %}>Autor</option>
            <option value="genero" {% if campo == 'genero' %}selected{% endif %}>Género</option>
        </select>
    </label>

    <!-- Campo para seleccionar el orden (ascendente/descendente) -->
    <label>
        Ordenar por
        <select name="orden" id="caracteristicaDos">
            <option value="Ascendente" {% if orden == 'Ascendente' %}selected{% endif %}>Ascendente</option>
            <option value="Descendente" {% if orden == 'Descendente' %}selected{% endif %}>Descendente</option>
        </select>
    </label>

    <!-- Input para búsqueda de texto -->
    <input type="text" name="q" value="{{ q }}" placeholder="Buscar libros..." />
    <button type="submit">Buscar</button>
    <button type="button" class="limpiar" id="btnLimpiar">Limpiar</button>
</form>

<!-- Si hay libros en la base de datos, mostrar tabla -->
{% if books %}
<div class="table-container">
<table>
    <thead>
        <tr>
            <!-- Cabeceras de la tabla -->
            <th>ID</th>
            <th>Título</th>
            <th>Autor</th>
            <th>Género</th>
            <th>Estado</th>
            <th>Acción</th>
        </tr>
    </thead>
    <tbody id="tabla-libros">
        {% for book in books %}
        <!-- Iteración de cada libro -->
        <tr>
            <td>{{ book.id_libro }}</td>
            <td>{{ book.titulo }}</td>
            <td>{{ book.autor }}</td>
            <td>{{ book.genero }}</td>
            <td class="estado-resumen">
                <!-- Muestra cuántos ejemplares disponibles y prestados hay -->
                {{ book.stock }} <span class="disponible">disponibles</span> - {{ book.prestados }} <span class="prestado">prestados</span>
            </td>
            <td>
                <div class="container-buttons">
                    <!-- Botón para editar -->
                    <form action="{{ url_for('editar', id_libro= book.id_libro) }}" method="get">
                        <button class="editar" type="submit">Editar</button>
                    </form>

                    <!-- Botón para eliminar -->
                    <form method="post" onsubmit="return mostrarAlerta(event,this)" action="{{ url_for('eliminar', id_libro= book.id_libro) }}">
                        <button class="eliminar" type="submit">Eliminar</button>
                    </form>
                </div>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
</div>
{% else %}
<!-- Si no hay libros registrados -->
<p>No hay libros registrados.</p>
{% endif %}

<hr />

<!-- Formulario para agregar un nuevo libro -->
<form id="formAgregar" method="POST" class="form-agregar-libro">
    <div class="campos-form">
        <!-- Campo título -->
        <div class="campo">
            <label for="input-titulo">Título:</label>
            <input id="input-titulo" type="text" name="titulo" placeholder="Ej: Rayuela" />
            <span class="error" data-field="titulo"></span>
        </div>

        <!-- Campo autor -->
        <div class="campo">
            <label for="input-autor">Autor:</label>
            <input id="input-autor" type="text" name="autor" placeholder="Ej: Julio Cortázar" />
            <span class="error" data-field="autor"></span>
        </div>

        <!-- Campo género -->
        <div class="campo">
            <label for="input-genero">Género:</label>
            <input id="input-genero" type="text" name="genero" placeholder="Ej: Ficción" />
            <span class="error" data-field="genero"></span>
        </div>

        <!-- Campo stock -->
        <div class="campo">
            <label for="input-stock">Stock:</label>
            <input id="input-stock" type="number" name="stock" placeholder="Ej: 20" />
            <span class="error" data-field="stock"></span>
        </div>
    </div>

    <button type="submit" class="btn-primario">Agregar Libro</button>
</form>

<!-- Librería de alertas modernas -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
/* ========= FUNCIÓN DE ALERTA DE ELIMINACIÓN ========= */
function mostrarAlerta(e, form) {
    e.preventDefault(); // Evita envío del formulario inmediato
    Swal.fire({
        title: "¿Desea eliminar el libro?",
        text: "Esta acción no se puede deshacer.",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "var(--color-primario-oscuro)",
        cancelButtonColor: "var(--rojo-error)",
        confirmButtonText: "Sí, eliminar",
        cancelButtonText: "Cancelar",
    }).then((result) => {
        if (result.isConfirmed) {
            // Si el usuario confirma, se realiza la petición con fetch
            fetch(form.action, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                }
            })
            .then(response => {
                // Si la respuesta redirige, seguir el enlace
                if (response.redirected) {
                    window.location.href = response.url;
                    return null;
                }
                // Si devuelve JSON, procesar datos
                return response.json();
            })
            .then(data => {
                // Si el backend devuelve error (ok: false)
                if (data && !data.ok) {
                    Swal.fire({
                        icon: "error",
                        title: "No se puede eliminar",
                        text: data.msg,
                        confirmButtonColor: "var(--color-primario-oscuro)"
                    });
                }
            })
            .catch(err => console.error("Error:", err));
        }
    });
    return false;
}
</script>

<!-- Validación del formulario de agregado -->
<script>
document.addEventListener("DOMContentLoaded", () => {
    /* Expresiones regulares de validación */
    const regex = {
        titulo: /^[A-Za-zÁÉÍÓÚáéíóúÑñ0-9\s.,:-]{2,}$/,
        autor: /^[A-Za-zÁÉÍÓÚáéíóúÑñ\s-]{3,}$/,
        genero: /^[A-Za-zÁÉÍÓÚáéíóúÑñ\s-]{3,}$/,
        stock: /^[0-9]+$/
    };

    /* Mensajes de error personalizados */
    const mensajes = {
        titulo: "El título debe tener al menos 2 caracteres y no contener símbolos especiales.",
        autor: "El autor debe tener al menos 3 letras y solo contener letras y espacios.",
        genero: "El género debe tener al menos 3 letras y solo contener letras y espacios.",
        stock: "El stock no puede ser negativo o nulo."
    };

    const form = document.getElementById("formAgregar");
    const inputs = form.querySelectorAll("input");

    // Función genérica para validar cada campo
    function validarCampo(input) {
        const valor = input.value.trim();
        const errorEl = input.parentElement.querySelector(".error");
        const name = input.name;

        // Campo vacío
        if (!valor) {
            errorEl.textContent = "Este campo es obligatorio.";
            input.classList.add("error-border");
            return false;
        }

        // Validación especial para stock numérico
        if (name === "stock") {
            const n = parseInt(valor,10);
            if (isNaN(n) || n < 1) {
                errorEl.textContent = mensajes.stock;
                input.classList.add("error-border");
                return false;
            }
            errorEl.textContent = "";
            input.classList.remove("error-border");
            return true;
        }

        // Validar usando regex
        if (!regex[name].test(valor)) {
            errorEl.textContent = mensajes[name];
            input.classList.add("error-border");
            return false;
        }

        // Si pasa todo, limpiar error
        errorEl.textContent = "";
        input.classList.remove("error-border");
        return true;
    }

    // Validación en tiempo real
    inputs.forEach(input => input.addEventListener("input", () => validarCampo(input)));

    // Validación al enviar el formulario
    form.addEventListener("submit", (e) => {
        let ok = true;
        inputs.forEach(i => { if (!validarCampo(i)) ok = false; });
        if (!ok) {
            e.preventDefault();
            Swal.fire({
                icon: "error",
                title: "Formulario incompleto",
                text: "Por favor, corrige los errores antes de continuar.",
                confirmButtonColor: "var(--color-primario-oscuro)"
            });
        }
    });

    /* Validación del formulario de búsqueda */
    const filtro = document.getElementById("filtrado");
    filtro.addEventListener("submit", (e) => {
        const q = filtro.querySelector('input[name="q"]').value.trim();
        if (!q || q.length < 2) {
            e.preventDefault();
            Swal.fire({
                icon: "error",
                title: "Búsqueda inválida",
                text: "La búsqueda debe tener al menos 2 caracteres.",
            });
        }
    });

    /* Botón de limpiar filtro */
    document.getElementById("btnLimpiar").addEventListener("click", () => {
        filtro.querySelectorAll("input").forEach(input => input.value = "");
        filtro.querySelectorAll("select").forEach(select => select.selectedIndex = 0);
        const inputBusqueda = filtro.querySelector('input[name="q"]');
        if (inputBusqueda) inputBusqueda.dispatchEvent(event);
    });
});
</script>

<!-- Búsqueda dinámica (AJAX) -->
<script>
document.addEventListener("DOMContentLoaded", () => {
    const inputBusqueda = document.querySelector('#filtrado input[name="q"]');
    const campoSelect = document.getElementById("caracteristica");
    const ordenSelect = document.getElementById("caracteristicaDos");
    const tbody = document.getElementById("tabla-libros");
    let timer;

    // Función para renderizar las filas de la tabla
    function renderRows(data) {
        tbody.innerHTML = "";
        if (!data || data.length === 0) {
            tbody.innerHTML = `<tr><td colspan="6">No hay resultados.</td></tr>`;
            return;
        }

        // Crear dinámicamente filas para cada libro
        data.forEach(book => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${book.id_libro}</td>
                <td>${book.titulo}</td>
                <td>${book.autor}</td>
                <td>${book.genero}</td>
                <td class="estado-resumen">
                    ${book.stock} <span class="disponible">disponibles</span> - ${book.prestados} <span class="prestado">prestados</span>
                </td>
                <td>
                    <div class="container-buttons">
                        <form method="get" action="/editar/${book.id_libro}">
                            <button class="editar" type="submit">Editar</button>
                        </form>
                        <form method="post" action="/eliminar/${book.id_libro}" onsubmit="return mostrarAlerta(event,this)">
                            <button class="eliminar" type="submit">Eliminar</button>
                        </form>
                    </div>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    // Si no existen elementos, terminar
    if (!inputBusqueda || !tbody) return;

    // Evento input: búsqueda en tiempo real
    inputBusqueda.addEventListener("input", () => {
        clearTimeout(timer);
        timer = setTimeout(() => {
            const q = inputBusqueda.value.trim();
            const campo = campoSelect.value;
            const orden = ordenSelect.value;

            // Petición fetch al backend para buscar libros
            fetch(`/buscar_libros?q=${q}&campo=${campo}&orden=${orden}`)
                .then(res => {
                    if (!res.ok) throw new Error('Error en la respuesta');
                    return res.json();
                })
                .then(data => renderRows(data))
                .catch(err => {
                    console.error("Error al buscar libros:", err);
                    tbody.innerHTML = `<tr><td colspan="6">Error al buscar resultados.</td></tr>`;
                });
        }, 300); // Delay para no saturar servidor
    });

    // Si se cambia el campo u orden, relanzar búsqueda
    [campoSelect, ordenSelect].forEach(select => {
        select.addEventListener("change", () => {
            inputBusqueda.dispatchEvent(new Event("input"));
        });
    });
});
</script>

<!-- Guardado y restauración de posición de scroll -->
<script>
window.addEventListener("beforeunload", () => {
    localStorage.setItem("scrollPosition", window.scrollY);
});
window.addEventListener("load", () => {
    const scrollPosition = localStorage.getItem("scrollPosition");
    if (scrollPosition) {
        window.scrollTo(0, scrollPosition);
        localStorage.removeItem("scrollPosition");
    }
});
</script>

{% endblock %}
