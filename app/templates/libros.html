{% extends "base.html" %} {% block title %}Gestión de Libros{% endblock %} {%
block content %}
<link rel="stylesheet" href="../static/css/libros.css" />
<h2>Gestión de Libros</h2>

<!-- Búsqueda -->
<form id="filtrado" method="get" action="{{ url_for('libros') }}">
    <label>
        Filtrar por
        <select name="campo" id="caracteristica">
            <option value="titulo" {% if campo == 'titulo' %}selected{% endif %}>Título</option>
            <option value="autor" {% if campo == 'autor' %}selected{% endif %}>Autor</option>
            <option value="genero" {% if campo == 'genero' %}selected{% endif %}>Género</option>
        </select>
    </label>

    <label>
        Ordenar por
        <select name="orden" id="caracteristicaDos">
            <option value="Ascendente" {% if orden == 'Ascendente' %}selected{% endif %}>Ascendente</option>
            <option value="Descendente" {% if orden == 'Descendente' %}selected{% endif %}>Descendente</option>
        </select>
    </label>

    <input type="text" name="q" value="{{ q }}" placeholder="Buscar..." />
    <button type="submit">Buscar</button>
    <button type="button" class="angryButton" id="btnLimpiar">Limpiar</button>
</form>


<!-- Tabla -->
{% if books %}
<div class="table-container">
<table>
    <thead>
        <tr>
            <th>ID</th>
            <th>Título</th>
            <th>Autor</th>
            <th>Género</th>
            <th>Estado</th>
            <th>Acción</th>
        </tr>
    </thead>
    <tbody>
        {% for book in books %}
        <tr>
            <td>{{ book.id_libro }}</td>
            <td>{{ book.titulo }}</td>
            <td>{{ book.autor }}</td>
            <td>{{ book.genero }}</td>
            <td class="estado-resumen">
                {{ book.stock }} <span class="disponible"">disponibles</span> - {{ book.prestados }}  <span class="prestado">prestados</span>
            </td>
            <td>
                <div class="container-buttons">
                    <form action="{{ url_for('editar', id_libro= book.id_libro) }}">
                        <button class="editar">Editar</button>
                    </form>
                    <form method="post"  onsubmit="mostrarAlerta(event,this)" action="{{ url_for('eliminar', id_libro= book.id_libro) }}">
                        <button class="eliminar">Eliminar</button>
                    </form>

                </div>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
</div>
{% else %}
<p>No hay libros registrados.</p>
{% endif %}
<hr />
<form id="formAgregar" method="POST" class="form-agregar-libro">
    <div class="campos-form">
        <div class="campo">
            <label for="input-titulo">Título:</label>
            <input
                id="input-titulo"
                type="text"
                name="titulo"
                placeholder="Ej: Rayuela"
            />
            <span class="error" data-field="titulo"></span>
        </div>

        <div class="campo">
            <label for="input-autor">Autor:</label>
            <input
                id="input-autor"
                type="text"
                name="autor"
                placeholder="Ej: Julio Cortázar"
            />
            <span class="error" data-field="autor"></span>
        </div>

        <div class="campo">
            <label for="input-genero">Género:</label>
            <input
                id="input-genero"
                type="text"
                name="genero"
                placeholder="Ej: Ficción"
            />
            <span class="error" data-field="genero"></span>
        </div>

        <div class="campo">
            <label for="input-stock">Stock:</label>
            <input
                id="input-stock"
                type="number"
                name="stock"
                placeholder="Ej: 20"
            />
            <span class="error" data-field="stock"></span>
        </div>
    </div>

    <button type="submit" class="btn-primario">Agregar Libro</button>
</form>


<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
    // === Expresiones regulares ===
    const regex = {
        titulo: /^[A-Za-zÁÉÍÓÚáéíóúÑñ0-9\s.,:-]{2,}$/,
        autor: /^[A-Za-zÁÉÍÓÚáéíóúÑñ\s-]{3,}$/,
        genero: /^[A-Za-zÁÉÍÓÚáéíóúÑñ\s-]{3,}$/
    };

    // === Mensajes de error personalizados ===
    const mensajes = {
        titulo: "El título debe tener al menos 2 caracteres y no contener símbolos especiales.",
        autor: "El autor debe tener al menos 3 letras y solo contener letras y espacios.",
        genero: "El género debe tener al menos 3 letras y solo contener letras y espacios."
    };

    // === Elementos del formulario ===
    const form = document.getElementById("formAgregar");
    const inputs = form.querySelectorAll("input");

    // === Validación en vivo ===
    inputs.forEach(input => {
        input.addEventListener("input", () => validarCampo(input));
    });

    function validarCampo(input) {
    const valor = input.value.trim();
    const error = input.parentElement.querySelector(".error");

    if (valor === "") {
        error.textContent = "Este campo es obligatorio.";
        error.classList.add("visible");
        input.classList.add("error-border");
        return false;
    } else if (!regex[input.name].test(valor)) {
        error.textContent = mensajes[input.name];
        error.classList.add("visible");
        input.classList.add("error-border");
        return false;
    } else {
        error.textContent = "";
        error.classList.remove("visible");
        input.classList.remove("error-border");
        return true;
    }
}

    // === Bloquear envío si hay errores ===
    form.addEventListener("submit", e => {
        let valido = true;

        inputs.forEach(input => {
            const ok = validarCampo(input);
            if (!ok) valido = false;
        });

        if (!valido) {
            e.preventDefault();
            Swal.fire({
                icon: "error",
                title: "Formulario incompleto",
                text: "Por favor, corrige los errores antes de continuar.",
                confirmButtonColor: "var(--color-primario-oscuro)"
            });
        }
    });

    // === VALIDAR FILTRADO ===
    const filtro = document.getElementById("filtrado");
    if (filtro) {
        filtro.addEventListener("submit", e => {
            const q = e.target.querySelector('input[name="q"]').value.trim();
            if (q && q.length < 2) {
                e.preventDefault();
                Swal.fire({
                    icon: "error",
                    title: "Búsqueda inválida",
                    text: "La búsqueda debe tener al menos 2 caracteres.",
                });
            }
        });
    }

    // === LIMPIAR FILTRO ===
    const btnLimpiar = document.getElementById("btnLimpiar");
    if (btnLimpiar) {
        btnLimpiar.addEventListener("click", () => {
            const form = document.getElementById("filtrado");
            form.querySelectorAll("input").forEach(input => input.value = "");
            form.querySelectorAll("select").forEach(select => select.selectedIndex = 0);
        });
    }
});
</script>
<!-- Resultado de busqueda -->
<script>
document.addEventListener("DOMContentLoaded", () => {
    const inputBusqueda = document.querySelector('#filtrado input[name="q"]');
    const campoSelect = document.getElementById("caracteristica");
    const ordenSelect = document.getElementById("caracteristicaDos");
    const tbody = document.querySelector("tbody");

    let timer;

    if (inputBusqueda && tbody) {
        inputBusqueda.addEventListener("input", () => {
            clearTimeout(timer);
            timer = setTimeout(() => {
                const q = inputBusqueda.value.trim();
                const campo = campoSelect.value;
                const orden = ordenSelect.value;

                fetch(`/buscar_libros?q=${encodeURIComponent(q)}&campo=${campo}&orden=${orden}`)
                    .then(res => res.json())
                    .then(data => {
                        tbody.innerHTML = "";

                        if (data.length === 0) {
                            tbody.innerHTML = `<tr><td colspan="6">No hay resultados.</td></tr>`;
                            return;
                        }

                        data.forEach(book => {
                            const tr = document.createElement("tr");
                            tr.innerHTML = `
                                <td>${book.id_libro}</td>
                                <td>${book.titulo}</td>
                                <td>${book.autor}</td>
                                <td>${book.genero}</td>
                                <td class="estado-resumen">
                                    ${book.stock} <span class="disponible"">disponibles</span> - ${book.prestado}  <span class="prestado">prestados</span>
                                </td>
                                <td>
                                    <div class="container-buttons">
                                        <form onsubmit="return mostrarAlerta(event, this)" method="post" action="/eliminar/${book.id_libro}">
                                            <button class="eliminar">Eliminar</button>
                                        </form>
                                        <form method="get" action="/editar/${book.id_libro}">
                                            <button class="editar" type="submit">Editar</button>
                                        </form>
                                        ${book.prestado ? `
                                        <form method="post" action="/devolver/${book.id_libro}">
                                            <button  type="submit" class="devolver">Devolver</button>
                                        </form>` : ""}
                                    </div>
                                </td>
                            `;
                            tbody.appendChild(tr);
                        });
                    })
                    .catch(err => console.error("Error al buscar libros:", err));
            }, 300); // espera 300ms entre tecleos
        });
    }

    // también actualizar al cambiar los selects
    [campoSelect, ordenSelect].forEach(select => {
        select.addEventListener("change", () => {
            inputBusqueda.dispatchEvent(new Event("input"));
        });
    });
});
</script>


<!-- Alerta de eliminación -->

<script>
    function mostrarAlerta(e, form) {
        e.preventDefault();
        Swal.fire({
            title: "¿Desea eliminar el libro?",
            text: "Esta acción no se puede deshacer.",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "var(--color-primario-oscuro)",
            cancelButtonColor: "var(--rojo-error)",
            confirmButtonText: "Sí, eliminar",
            cancelButtonText: "Cancelar",
        }).then((result) => {
            if (result.isConfirmed) {
                form.submit();
            }
        });
        return false;
    }
</script>
<!-- Script para guardar la posicion del scroll donde estaba el usuario y no se recargue la pagina y redireccione hacia arriba del todo -->
<script>
    window.addEventListener("beforeunload", (e) => {
        localStorage.setItem("scrollPosition", window.scrollY);
    });

    window.addEventListener("load", () => {
        const scrollPosition = localStorage.getItem("scrollPosition");
        if (scrollPosition) {
            window.scrollTo(0, scrollPosition);
            localStorage.removeItem("scrollPosition");
        }
    });
</script>
{% endblock %}
