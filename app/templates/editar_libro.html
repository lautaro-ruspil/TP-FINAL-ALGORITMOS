{% extends "base.html" %} {% block title %}Editar Libro{% endblock %} {% block
content %}
<link rel="stylesheet" href="../static/css/libros.css" />

<h2>Editar Libro</h2>

<form
    id="formEditar"
    method="POST"
    class="form-editar-libro"
    action="{{ url_for('editar', id_libro=libro.id_libro) }}"
>
    <div class="campos-form">
        <div class="campo">
            <label for="input-titulo">Título:</label>
            <input
                id="input-titulo"
                type="text"
                name="titulo"
                value="{{ libro.titulo }}"
                placeholder="Ej: Rayuela"
            />
            <span class="error" data-field="titulo"></span>
        </div>

        <div class="campo">
            <label for="input-autor">Autor:</label>
            <input
                id="input-autor"
                type="text"
                name="autor"
                value="{{ libro.autor }}"
                placeholder="Ej: Julio Cortázar"
            />
            <span class="error" data-field="autor"></span>
        </div>

        <div class="campo">
            <label for="input-genero">Género:</label>
            <input
                id="input-genero"
                type="text"
                name="genero"
                value="{{ libro.genero }}"
                placeholder="Ej: Ficción"
            />
            <span class="error" data-field="genero"></span>
        </div>

        <div class="campo">
            <label for="input-stock">Stock:</label>
            <input
                id="input-stock"
                type="number"
                name="stock"
                min="{{ libro.stock }}"
                value="{{ libro.stock }}"
                placeholder="Ej: 20"
            />
            <span class="error" data-field="stock"></span>
        </div>
    </div>

    <div class="acciones-form">
        <button type="submit" class="btn-primario">Guardar cambios</button>
        <a href="{{ url_for('libros') }}">
            <button type="button" class="angryButton">Cancelar</button>
        </a>
    </div>
</form>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        // === Expresiones regulares ===
        const regex = {
            titulo: /^[A-Za-zÁÉÍÓÚáéíóúÑñ0-9\s.,:-]{2,}$/,
            autor: /^[A-Za-zÁÉÍÓÚáéíóúÑñ\s-]{3,}$/,
            genero: /^[A-Za-zÁÉÍÓÚáéíóúÑñ\s-]{3,}$/,
            stock: /^[0-9]+$/,
        };

        const mensajes = {
            titulo: "El título debe tener al menos 2 caracteres y no contener símbolos especiales.",
            autor: "El autor debe tener al menos 3 letras y solo contener letras y espacios.",
            genero: "El género debe tener al menos 3 letras y solo contener letras y espacios.",
            stock: "El stock debe ser un número entero positivo.",
        };

        const form = document.getElementById("formEditar");
        const inputs = form.querySelectorAll("input");
        const stockInput = document.getElementById("input-stock");
        const stockOriginal = parseInt(stockInput.value);

        // === Evitar disminuir stock ===
        stockInput.addEventListener("input", () => {
            const nuevoValor = parseInt(stockInput.value);
            if (nuevoValor < stockOriginal) {
                stockInput.value = stockOriginal;
                Swal.fire({
                    icon: "warning",
                    title: "No permitido",
                    text: "El stock no puede ser menor al actual.",
                    confirmButtonColor: "var(--color-primario-oscuro)",
                });
            }
        });

        // === Validación de campos ===
        inputs.forEach((input) => {
            input.addEventListener("input", () => validarCampo(input));
        });

        function validarCampo(input) {
            const valor = input.value.trim();
            const error = input.parentElement.querySelector(".error");

            if (valor === "") {
                error.textContent = "Este campo es obligatorio.";
                error.classList.add("visible");
                input.classList.add("error-border");
                return false;
            } else if (!regex[input.name].test(valor)) {
                error.textContent = mensajes[input.name];
                error.classList.add("visible");
                input.classList.add("error-border");
                return false;
            } else {
                error.textContent = "";
                error.classList.remove("visible");
                input.classList.remove("error-border");
                return true;
            }
        }

        // === Envío del formulario con confirmación ===
        form.addEventListener("submit", async (e) => {
            e.preventDefault();

            // Validar todos los campos antes de enviar
            let valido = true;
            inputs.forEach((input) => {
                const ok = validarCampo(input);
                if (!ok) valido = false;
            });

            if (!valido) {
                Swal.fire({
                    icon: "error",
                    title: "Formulario incompleto",
                    text: "Por favor, corrige los errores antes de guardar.",
                    confirmButtonColor: "var(--color-primario-oscuro)",
                });
                return;
            }

            // Confirmación antes de enviar
            const result = await Swal.fire({
                title: "¿Guardar cambios?",
                text: "Se actualizarán los datos del libro.",
                icon: "question",
                showCancelButton: true,
                confirmButtonColor: "var(--color-primario-oscuro)",
                cancelButtonColor: "var(--rojo-error)",
                confirmButtonText: "Sí, guardar",
                cancelButtonText: "Cancelar",
            });

            if (!result.isConfirmed) return;

            // Enviar con fetch
            const formData = new FormData(form);
            const response = await fetch(form.action, {
                method: "POST",
                body: formData,
            });

            if (response.ok) {
                Swal.fire({
                    icon: "success",
                    title: "Cambios guardados",
                    text: "El libro se actualizó correctamente.",
                    timer: 2000,
                    showConfirmButton: false,
                    willClose: () => {
                        window.location.href = "{{ url_for('libros') }}";
                    },
                });
            } else {
                Swal.fire({
                    icon: "error",
                    title: "Error",
                    text: "Ocurrió un problema al guardar los cambios.",
                });
            }
        });
    });
</script>
{% endblock %}
