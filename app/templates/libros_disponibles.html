{% extends "base.html" %} {% block title %}Seleccionar Libro para Préstamo{%
endblock %} {% block extra_css %}
<link
    rel="stylesheet"
    href="{{ url_for('static', filename='css/libros_disponibles.css') }}"
/>
{% endblock %} {% block content %}

<h2>Seleccionar Libro para Préstamo</h2>
<p class="usuario-target">
    Prestando a: {{ usuario.nombre }} {{ usuario.apellido }} (DNI: {{
    usuario.dni }})
</p>

<div class="table-container">
    {% if libros %}
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Título</th>
                <th>Autor</th>
                <th>Género</th>
                <th>Acción</th>
            </tr>
        </thead>
        <tbody>
            {% for libro in libros %}
            <tr>
                <td>{{ libro.id_libro }}</td>
                <td>{{ libro.titulo }}</td>
                <td>{{ libro.autor }}</td>
                <td>{{ libro.genero }}</td>
                <td>
                    <div class="container-action">
                        {% if libro in usuario.libros %}
                        <button class="btn-prestado" disabled>
                            Ya prestado
                        </button>
                        {% else %}
                        <form
                            action="{{ url_for('confirmar_prestamo', id_usuario=usuario.id_usuario, id_libro=libro.id_libro) }}"
                            method="post"
                        >
                            <button class="btn-prestar" type="submit">
                                Prestar
                            </button>
                        </form>
                        {% endif %}
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p class="no-libros">Actualmente no hay libros disponibles para prestar.</p>
    {% endif %}
</div>

<div class="container-volver">
    <a href="{{ url_for('usuarios') }}" class="btn-volver"> Cancelar </a>
</div>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    document.querySelectorAll(".btn-prestar").forEach((button) => {
        button.addEventListener("click", async (event) => {
            event.preventDefault();
            const form = event.target.closest("form");

            const confirm = await Swal.fire({
                title: "¿Confirmar préstamo?",
                text: "¿Deseas prestar este libro al usuario?",
                icon: "question",
                showCancelButton: true,
                confirmButtonColor: "var(--color-primario-oscuro)",
                cancelButtonColor: "var(--rojo-error)",
                confirmButtonText: "Sí, prestar",
                cancelButtonText: "Cancelar",
            });

            if (!confirm.isConfirmed) return;

            Swal.fire({
                title: "Procesando...",
                text: "Registrando el préstamo, por favor espera.",
                allowOutsideClick: false,
                didOpen: () => Swal.showLoading(),
            });

            const response = await fetch(form.action, {
                method: "POST",
            });

            const data = await response.json();

            Swal.close();

            if (data.ok) {
                Swal.fire({
                    icon: "success",
                    title: "Préstamo exitoso",
                    text: data.msg,
                    timer: 2000,
                    showConfirmButton: false,
                    willClose: () => window.location.reload(),
                });
            } else {
                Swal.fire({
                    icon: "error",
                    title: "No se pudo realizar el préstamo",
                    text: data.msg,
                    confirmButtonColor: "var(--color-primario-oscuro)",
                });
            }
        });
    });
</script>
{% endblock %}
