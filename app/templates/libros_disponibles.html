{% extends "base.html" %} {% block title %}Seleccionar Libro para Préstamo{%
endblock %} {% block extra_css %}
<link
    rel="stylesheet"
    href="{{ url_for('static', filename='css/libros_disponibles.css') }}"
/>
{% endblock %} {% block content %}

<h2>Seleccionar Libro para Préstamo</h2>
<p class="usuario-target">
    Prestando a: {{ usuario.nombre }} {{ usuario.apellido }} (DNI: {{
    usuario.dni }})
</p>

<div class="table-container">
    {% if libros %}
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Título</th>
                <th>Autor</th>
                <th>Género</th>
                <th>Acción</th>
            </tr>
        </thead>
        <tbody>
            {% for libro in libros %}
            <tr>
                <td>{{ libro.id_libro }}</td>
                <td>{{ libro.titulo }}</td>
                <td>{{ libro.autor }}</td>
                <td>{{ libro.genero }}</td>
                <td>
                    <div class="container-action">
                        <form
                            action="{{ url_for('confirmar_prestamo', id_usuario=usuario.id_usuario, id_libro=libro.id_libro) }}"
                            method="post"
                        >
                            <button class="btn-prestar" type="submit">
                                Prestar
                            </button>
                        </form>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p class="no-libros">Actualmente no hay libros disponibles para prestar.</p>
    {% endif %}
</div>

<div class="container-volver">
    <a href="{{ url_for('usuarios') }}" class="btn-volver"> Cancelar </a>
</div>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    document.querySelectorAll(".btn-prestar").forEach((button) => {
        button.addEventListener("click", async (event) => {
            event.preventDefault(); // Evita envío inmediato

            const form = event.target.closest("form");

            // Confirmación
            const result = await Swal.fire({
                title: "¿Confirmar préstamo?",
                text: "¿Deseas prestar este libro al usuario?",
                icon: "question",
                showCancelButton: true,
                confirmButtonColor: "#3085d6",
                cancelButtonColor: "#d33",
                confirmButtonText: "Sí, prestar",
                cancelButtonText: "Cancelar",
            });

            if (!result.isConfirmed) return;

            // Mostrar "procesando..."
            Swal.fire({
                title: "Procesando...",
                text: "Registrando el préstamo, por favor espera.",
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                },
            });

            // Enviar el formulario vía fetch
            const response = await fetch(form.action, {
                method: "POST",
                body: new FormData(form),
            });

            if (response.ok) {
                Swal.fire({
                    icon: "success",
                    title: "Préstamo realizado",
                    text: "El libro fue prestado correctamente.",
                    timer: 2000,
                    showConfirmButton: false,
                    willClose: () => {
                        // Redirige automáticamente a la lista de usuarios
                        window.location.href = "{{ url_for('usuarios') }}";
                    },
                });
            } else {
                Swal.fire({
                    icon: "error",
                    title: "Error",
                    text: "Ocurrió un problema al registrar el préstamo.",
                });
            }
        });
    });
</script>
{% endblock %}
