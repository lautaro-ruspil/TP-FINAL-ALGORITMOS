{% extends "base.html" %}
{% block title %}Gestión de Usuarios{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/usuarios.css') }}">
{% endblock %}

{% block content %}
<h2>Gestión de Usuarios</h2>

<!-- FILTRO DE BÚSQUEDA -->
<form id="filtrado" method="get" action="{{ url_for('usuarios') }}">
    <label>
        Filtrar por
        <select name="campo" id="campoUsuario">
            <option value="nombre" {% if campo == 'nombre' %}selected{% endif %}>Nombre</option>
            <option value="apellido" {% if campo == 'apellido' %}selected{% endif %}>Apellido</option>
            <option value="dni" {% if campo == 'dni' %}selected{% endif %}>DNI</option>
            <option value="libros" {% if campo == 'libros' %}selected{% endif %}>Libros</option>
        </select>
    </label>

    <label>
        Ordenar por
        <select name="orden" id="ordenUsuario">
            <option value="Ascendente" {% if orden == 'Ascendente' %}selected{% endif %}>Ascendente</option>
            <option value="Descendente" {% if orden == 'Descendente' %}selected{% endif %}>Descendente</option>
        </select>
    </label>

    <input type="text" name="q" id="buscarUsuario" value="{{ q }}" placeholder="Buscar usuario..." />
    <button type="submit">Buscar</button>
    <button type="button" class="angryButton" id="btnLimpiarUsuarios">Limpiar</button>
</form>

<!-- TABLA DE USUARIOS -->
{% if users %}
<div class="table-container">
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Nombres</th>
                <th>Apellido</th>
                <th>DNI</th>
                <th>Teléfono</th>
                <th>Dirección</th>
                <th>N° Dir.</th>
                <th>Libros en propiedad</th>
                <th>Acciones</th>
            </tr>
        </thead>

        <tbody>
            {% for user in users %}
            <tr>
                <td>{{ user.id_usuario }}</td>
                <td>{{ user.nombre }}</td>
                <td>{{ user.apellido }}</td>
                <td>{{ user.dni }}</td>
                <td>{{ user.telefono }}</td>
                <td>{{ user.direccion }}</td>
                <td>{{ user.nro_direccion }}</td>
                <td>
                    {% if user.libros %}
                        {% for libro in user.libros %}
                            <p>{{ libro.titulo }} - <span style="font-weight: 600">{{ libro.autor }}</span></p>
                        {% endfor %}
                    {% else %}
                        <p>-</p>
                    {% endif %}
                </td>
                <td>
                    <div class="container-buttons">
                        <form method="get" action="{{ url_for('editar_usuario', id_usuario=user.id_usuario) }}">
                            <button class="editar">Editar</button>
                        </form>
                        <form method="post" action="{{ url_for('eliminar_usuario', id_usuario=user.id_usuario) }}" onsubmit="return mostrarAlerta(event, this)">
                            <button class="eliminar">Eliminar</button>
                        </form>
                        <form method="get" action="{{ url_for('seleccionar_libro_prestamo', id_usuario=user.id_usuario) }}">
                            <button class="prestar">Prestar Libro</button>
                        </form>

                        {% if user.libros and user.libros|length > 0 %}
                            <form method="get" action="{{ url_for('devolver_libro', id_usuario=user.id_usuario) }}">
                                <button class="devolver">Devolver Libro</button>
                            </form>
                        {% endif %}
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<p>No hay usuarios registrados.</p>
{% endif %}

<hr />

<!-- FORMULARIO DE NUEVO USUARIO -->
<form action="/usuarios" method="post" class="form-usuario" id="form-usuario">
    <div>
        <label for="nombre">Nombres:</label>
        <input type="text" id="nombre" name="nombre" placeholder="Juan"  />
        <p id="error-nombre" class="error"></p>
    </div>

    <div>
        <label for="apellido">Apellido:</label>
        <input type="text" id="apellido" name="apellido" placeholder="Pérez"  />
        <p id="error-apellido" class="error"></p>
    </div>

    <div>
        <label for="dni">DNI:</label>
        <input type="number" id="dni" name="dni" placeholder="1234567"  />
        <p id="error-dni" class="error"></p>
    </div>

    <div>
        <label for="telefono">Teléfono:</label>
        <input type="text" id="telefono" name="telefono" placeholder="2284-123456" />
        <p id="error-telefono" class="error"></p>
    </div>

    <div>
        <label for="direccion">Dirección:</label>
        <input type="text" id="direccion" name="direccion" placeholder="Hornos" />
        <p id="error-direccion" class="error"></p>
    </div>

    <div>
        <label for="nro_direccion">N° Dirección:</label>
        <input type="number" id="nro_direccion" name="nro_direccion" placeholder="2025" />
        <p id="error-nro_direccion" class="error"></p>
    </div>

    <button type="submit">Agregar</button>
</form>

<script>
document.addEventListener("DOMContentLoaded", () => {
    // === Expresiones regulares ===
    const regex = {
        nombre: /^[A-Za-zÁÉÍÓÚáéíóúÑñ\s]{2,}$/,                  // solo letras y espacios, min 2 caracteres
        apellido: /^[A-Za-zÁÉÍÓÚáéíóúÑñ\s]{2,}$/,                // solo letras y espacios, min 2 caracteres
        dni: /^[0-9]{7,8}$/,                                     // 7 u 8 dígitos
        telefono: /^[0-9\-]{11}$/,                               // permite - y 11 dígitos contado el guión
        direccion: /^[A-Za-zÁÉÍÓÚáéíóúÑñ0-9\s.,-]{3,}$/,          // letras, números, espacios y símbolos básicos
        nro_direccion: /^[0-9]{1,5}$/                            // número entre 1 y 5 dígitos
    };

    // === Mensajes de error personalizados ===
    const mensajes = {
        nombre: "El nombre debe tener al menos 2 letras y solo puede contener letras y espacios.",
        apellido: "El apellido debe tener al menos 2 letras y solo puede contener letras y espacios.",
        dni: "El DNI debe tener entre 7 y 8 dígitos numéricos.",
        telefono: "El teléfono solo puede contener digitos y debe estar en formato xxxx-xxxxxx",
        direccion: "La dirección debe tener al menos 3 caracteres válidos.",
        nro_direccion: "El número de dirección debe ser un número de hasta 5 dígitos."
    };

    // === Elementos del formulario ===
    const form = document.getElementById("form-usuario");
    const inputs = form.querySelectorAll("input");

    // === Validación en vivo ===
    inputs.forEach(input => {
        input.addEventListener("input", () => validarCampo(input));
    });

    function validarCampo(input) {
        const valor = input.value.trim();
        const error = input.parentElement.querySelector(".error");

        // Si el campo está vacío
        if (valor === "") {
            error.textContent = "Este campo es obligatorio.";
            error.classList.add("visible");
            input.classList.add("error-border");
            return false;
        }

        // Si no cumple con el patrón
        else if (regex[input.name] && !regex[input.name].test(valor)) {
            error.textContent = mensajes[input.name];
            error.classList.add("visible");
            input.classList.add("error-border");
            return false;
        }

        // Si está todo bien
        else {
            error.textContent = "";
            error.classList.remove("visible");
            input.classList.remove("error-border");
            return true;
        }
    }

    // === Bloquear envío si hay errores ===
    form.addEventListener("submit", e => {
        let valido = true;

        inputs.forEach(input => {
            const ok = validarCampo(input);
            if (!ok) valido = false;
        });

        if (!valido) {
            e.preventDefault();
            Swal.fire({
                icon: "error",
                title: "Formulario incompleto",
                text: "Por favor, corrige los errores antes de continuar.",
                confirmButtonColor: "var(--color-primario-oscuro)"
            });
        }
    });
});
</script>

<!-- FILTRADO EN VIVO -->
<script>
document.addEventListener("DOMContentLoaded", () => {
    const inputBusqueda = document.querySelector('#buscarUsuario');
    const campoSelect = document.querySelector('#campoUsuario');
    const ordenSelect = document.querySelector('#ordenUsuario');
    const tbody = document.querySelector('tbody');
    const btnLimpiar = document.querySelector('#btnLimpiarUsuarios');
    let timer;

    if (inputBusqueda && tbody) {
        inputBusqueda.addEventListener("input", () => {
            clearTimeout(timer);
            timer = setTimeout(() => {
                const q = inputBusqueda.value.trim();
                const campo = campoSelect.value;
                const orden = ordenSelect.value;

                fetch(`/buscar_usuarios?q=${encodeURIComponent(q)}&campo=${campo}&orden=${orden}`)
                    .then(res => res.json())
                    .then(data => {
                        tbody.innerHTML = "";

                        if (data.length === 0) {
                            tbody.innerHTML = `<tr><td colspan="9">No hay resultados.</td></tr>`;
                            return;
                        }

                        data.forEach(user => {
                            const librosHTML = user.libros && user.libros.length > 0
                                ? user.libros.map(l => `<p>${l.titulo} - <strong>${l.autor}</strong></p>`).join("")
                                : "<p>-</p>";

                            const devolverBtn = user.libros && user.libros.length > 0
                                ? `<form method="get" action="/devolver_libro/${user.id_usuario}">
                                       <button class="devolver">Devolver Libro</button>
                                   </form>`
                                : "";

                            const tr = document.createElement("tr");
                            tr.innerHTML = `
                                <td>${user.id_usuario}</td>
                                <td>${user.nombre}</td>
                                <td>${user.apellido}</td>
                                <td>${user.dni}</td>
                                <td>${user.telefono}</td>
                                <td>${user.direccion}</td>
                                <td>${user.nro_direccion}</td>
                                <td>${librosHTML}</td>
                                <td>
                                    <div class="container-buttons">
                                        <form method="get" action="/editar_usuario/${user.id_usuario}">
                                            <button class="editar">Editar</button>
                                        </form>
                                        <form method="post" action="/eliminar_usuario/${user.id_usuario}" onsubmit="return mostrarAlerta(event,this)">
                                            <button class="eliminar">Eliminar</button>
                                        </form>
                                        <form method="get" action="/seleccionar_libro_prestamo/${user.id_usuario}">
                                            <button class="prestar">Prestar Libro</button>
                                        </form>
                                        ${devolverBtn}
                                    </div>
                                </td>
                            `;
                            tbody.appendChild(tr);
                        });
                    })
                    .catch(err => console.error("Error al buscar usuarios:", err));
            }, 300);
        });
    }

    [campoSelect, ordenSelect].forEach(select => {
        select.addEventListener("change", () => {
            inputBusqueda.dispatchEvent(new Event("input"));
        });
    });

    btnLimpiar.addEventListener("click", () => {
        inputBusqueda.value = "";
        campoSelect.selectedIndex = 0;
        ordenSelect.selectedIndex = 0;
        inputBusqueda.dispatchEvent(new Event("input"));
    });
});
</script>

<!-- SWEET ALERT PARA ELIMINACIÓN -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
function mostrarAlerta(e, form) {
    e.preventDefault();
    Swal.fire({
        title: "¿Desea eliminar al usuario?",
        text: "Esta acción no se puede deshacer.",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "var(--rojo-error)",
        cancelButtonColor: "var(--color-primario-oscuro)",
        confirmButtonText: "Sí, eliminar",
        cancelButtonText: "Cancelar",
    }).then((result) => {
        if (result.isConfirmed) form.submit();
    });
    return false;
}
</script>
<!-- Script para guardar la posicion del scroll donde estaba el usuario y no se recargue la pagina y redireccione hacia arriba del todo -->
<script>
    window.addEventListener("beforeunload", (e) => {
        localStorage.setItem("scrollPosition", window.scrollY);
    });

    window.addEventListener("load", () => {
        const scrollPosition = localStorage.getItem("scrollPosition");
        if (scrollPosition) {
            window.scrollTo(0, scrollPosition);
            localStorage.removeItem("scrollPosition");
        }
    });
</script>
{% endblock %}
