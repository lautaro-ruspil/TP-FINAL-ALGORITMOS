{% extends "base.html" %} {% block title %}Usuarios{% endblock %} {% block
extra_css %}

<link
    rel="stylesheet"
    href="{{ url_for('static', filename='css/usuarios.css') }}"
/>
{% endblock %} {% block content %}

<h2>Gestión de Usuarios</h2>

{% if users %}

<div class="table-container">
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Nombres</th>
                <th>Apellido</th>
                <th>DNI</th>
                <th>Teléfono</th>
                <th>Dirección</th>
                <th>N° Dir.</th>
                <th>Libros en propiedad</th>
                <th>Acciones</th>
            </tr>
        </thead>

        <tbody>
            {% for user in users %}
            <tr>
                <th>{{user.id_usuario}}</th>
                <td>{{user.nombre}}</td>
                <td>{{user.apellido}}</td>
                <td>{{user.dni}}</td>
                <td>{{user.telefono}}</td>
                <td>{{user.direccion}}</td>
                <td>{{user.nro_direccion}}</td>
                <td>
                    {% if user.libros %} {% for libro in user.libros %}
                    <p>
                        {{libro.titulo}} - <br />
                        <span style="font-weight: 600">{{libro.autor}}</span>
                    </p>
                    {% endfor %} {% else %}
                    <p>-</p>
                    {% endif %}
                </td>
                <td>
                    <div class="container-buttons">
                        <form
                            method="get"
                            action="{{ url_for('editar_usuario', id_usuario=user.id_usuario) }}"
                        >
                            <button>Editar</button>
                        </form>
                        <form
                            method="post"
                            action="{{ url_for('eliminar_usuario', id_usuario=user.id_usuario) }}"
                            onsubmit="return mostrarAlerta(event, this)"
                        >
                            <button>Eliminar</button>
                        </form>
                        <form
                            method="get"
                            action="{{ url_for('seleccionar_libro_prestamo', id_usuario=user.id_usuario) }}"
                        >
                            <button>Prestar Libro</button>
                        </form>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<p>No hay usuarios registrados</p>
{% endif %}

<hr />

<form action="/usuarios" method="post" class="form-usuario" id="form-usuario">
    <div>
        <label for="nombre">Nombres:</label>
        <input type="text" id="nombre" name="nombre" placeholder="Juan" />
        <p id="error-nombre" class="error"></p>
    </div>

    <div>
        <label for="apellido">Apellido:</label>
        <input type="text" id="apellido" name="apellido" placeholder="Pérez" />
        <p id="error-apellido" class="error"></p>
    </div>

    <div>
        <label for="dni">DNI:</label>
        <input type="number" id="dni" name="dni" placeholder="1234567" />
        <p id="error-dni" class="error"></p>
    </div>

    <div>
        <label for="telefono">Teléfono:</label>
        <input
            type="text"
            id="telefono"
            name="telefono"
            placeholder="2284-123456"
        />
        <p id="error-telefono" class="error"></p>
    </div>

    <div>
        <label for="direccion">Dirección:</label>
        <input
            type="text"
            id="direccion"
            name="direccion"
            placeholder="hornos"
        />
        <p id="error-direccion" class="error"></p>
    </div>

    <div>
        <label for="nro_direccion">N° Dirección:</label>
        <input
            type="number"
            id="nro_direccion"
            name="nro_direccion"
            placeholder="2025"
        />

        <p id="error-nro_direccion" class="error"></p>
    </div>

    <button type="submit">Agregar</button>
</form>
<!-- Validacion de formulario -->
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const regex = {
            nombre: /^[A-Za-zÁÉÍÓÚáéíóúñÑ\s]{3,}$/,
            apellido: /^[A-Za-zÁÉÍÓÚáéíóúñÑ\s]{3,}$/,
            dni: /^\d{7,8}$/,
            telefono: /^\d{4}-\d{6}$/,
            direccion: /^.{2,}$/,
            nro_direccion: /^\d+$/,
        };

        const mensajes = {
            nombre: "El nombre debe tener al menos 3 letras y solo contener letras.",
            apellido:
                "El apellido debe tener al menos 3 letras y solo contener letras.",
            dni: "El DNI debe tener 7 u 8 dígitos numéricos.",
            telefono: "El teléfono debe tener el formato XXXX-XXXXXX.",
            direccion: "La dirección debe tener al menos 2 caracteres.",
            nro_direccion: "El número de dirección debe contener solo números.",
        };

        const form = document.getElementById("form-usuario");
        const inputs = document.querySelectorAll(".form-usuario input");

        // Validación en vivo
        inputs.forEach((input) => {
            input.addEventListener("input", () => validarCampo(input));
        });

        // Función que valida cada campo
        function validarCampo(input) {
            const valor = input.value.trim();
            const error = input.parentElement.querySelector(".error");

            if (valor === "") {
                error.textContent = "Este campo es obligatorio.";
                input.classList.add("input-error");
                return false;
            } else if (!regex[input.name].test(valor)) {
                error.textContent = mensajes[input.name];
                input.classList.add("input-error");
                return false;
            } else {
                error.textContent = "";
                input.classList.remove("input-error");
                return true;
            }
        }

        // Bloquear envío si hay errores
        form.addEventListener("submit", (e) => {
            let valido = true;

            inputs.forEach((input) => {
                const ok = validarCampo(input);
                if (!ok) valido = false;
            });

            if (!valido) {
                e.preventDefault();
                Swal.fire({
                    icon: "error",
                    title: "Formulario incompleto",
                    text: "Por favor, corrige los errores antes de continuar.",
                    confirmButtonColor: "var(--color-primario-oscuro)",
                });
            }
        });
    });
</script>
<!-- Sweet alert para confirmación de eliminación de usuario -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    function mostrarAlerta(e, form) {
        e.preventDefault(); // evita que el formulario se envíe automáticamente

        Swal.fire({
            title: "¿Desea eliminar al usuario?",
            text: "Esta acción no se puede deshacer.",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "var(--rojo-error)",
            cancelButtonColor: "var(--color-primario-oscuro)",
            confirmButtonText: "Sí, eliminar",
            cancelButtonText: "Cancelar",
        }).then((result) => {
            if (result.isConfirmed) {
                form.submit(); // envía el formulario solo si confirma
            }
        });

        return false; // evita que el form se envíe de inmediato
    }
</script>
<!-- Script para guardar la posicion del scroll donde estaba el usuario y no se recargue la pagina y redireccione hacia arriba del todo -->
<script>
    window.addEventListener("beforeunload", () => {
        localStorage.setItem("scrollPosition", window.scrollY);
    });

    window.addEventListener("load", () => {
        const scrollPosition = localStorage.getItem("scrollPosition");
        if (scrollPosition) {
            window.scrollTo(0, scrollPosition);
            localStorage.removeItem("scrollPosition");
        }
    });
</script>

{% endblock %}
